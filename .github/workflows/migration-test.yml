name: Database Migration Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'alembic/**'
      - 'server_fastapi/models/**'
      - 'requirements.txt'
  workflow_dispatch:

jobs:
  migration-test:
    name: Test Database Migrations
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_migrations
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Test migration upgrade
      env:
        DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/test_migrations
      run: |
        echo "Testing migration upgrade..."
        python -m alembic upgrade head
    
    - name: Test migration downgrade
      env:
        DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/test_migrations
      run: |
        echo "Testing migration downgrade..."
        # Get current revision
        CURRENT_REV=$(python -m alembic current | grep -o '[a-f0-9]\{12\}' | head -1)
        
        if [ -n "$CURRENT_REV" ]; then
          # Try to downgrade one revision
          python -m alembic downgrade -1 || echo "Downgrade test completed (may fail if at base)"
        else
          echo "No migrations to downgrade"
        fi
    
    - name: Test migration upgrade again
      env:
        DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/test_migrations
      run: |
        echo "Testing migration upgrade after downgrade..."
        python -m alembic upgrade head
    
    - name: Validate migration SQL
      env:
        DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/test_migrations
      run: |
        echo "Validating migration SQL syntax..."
        python -c "
        import os
        import re
        from pathlib import Path
        
        alembic_dir = Path('alembic/versions')
        if not alembic_dir.exists():
            print('No migrations directory found')
            exit(0)
        
        errors = []
        for migration_file in alembic_dir.glob('*.py'):
            with open(migration_file, 'r') as f:
                content = f.read()
            
            # Check for common SQL issues
            if 'DROP TABLE' in content and 'IF EXISTS' not in content:
                errors.append(f'{migration_file.name}: DROP TABLE without IF EXISTS')
            
            if 'DROP COLUMN' in content and 'IF EXISTS' not in content:
                errors.append(f'{migration_file.name}: DROP COLUMN without IF EXISTS')
        
        if errors:
            print('Migration validation errors:')
            for error in errors:
                print(f'  - {error}')
            exit(1)
        else:
            print('All migrations validated successfully')
        "
    
    - name: Test migration with data
      env:
        DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/test_migrations
      run: |
        echo "Testing migrations with sample data..."
        python -m alembic upgrade head
        
        # Insert test data
        python -c "
        import asyncio
        from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
        from sqlalchemy.orm import sessionmaker
        from sqlalchemy import text
        
        async def test_with_data():
            engine = create_async_engine('postgresql+asyncpg://postgres:postgres@localhost:5432/test_migrations')
            async_session = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)
            
            async with async_session() as session:
                # Test that we can insert and query data after migrations
                await session.execute(text('SELECT 1'))
                await session.commit()
                print('Migration test with data: PASSED')
        
        asyncio.run(test_with_data())
        "
