name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Install linters and type checkers
        run: |
          python -m pip install ruff mypy

      - name: Run linting (ruff)
        run: |
          ruff check . || true

      - name: Run static types (mypy)
        run: |
          mypy --ignore-missing-imports server_fastapi || true

      - name: Run tests
        run: |
          pytest -q
      
      - name: Run marketplace tests
        run: |
          pytest server_fastapi/tests/test_marketplace*.py server_fastapi/tests/test_indicator*.py -v || true
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  python-tests:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Lint with flake8
      run: |
        pip install flake8
        # Stop the build if there are Python syntax errors or undefined names
        flake8 server_fastapi --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 server_fastapi --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Format check with black
      run: |
        pip install black
        black --check server_fastapi
    
    - name: Run pytest with coverage
      run: |
        pytest server_fastapi/tests/ -v --tb=short --cov=server_fastapi --cov-report=xml --cov-report=html --cov-report=term-missing --cov-fail-under=85 --maxfail=5 --reruns=2 --reruns-delay=1
      env:
        DATABASE_URL: sqlite:///./test.db
    
    - name: Run marketplace-specific tests
      run: |
        pytest server_fastapi/tests/test_marketplace*.py server_fastapi/tests/test_indicator*.py -v --cov=server_fastapi.services.marketplace_service --cov=server_fastapi.services.indicator_service --cov=server_fastapi.services.indicator_execution_engine --cov-report=term-missing
      env:
        DATABASE_URL: sqlite:///./test.db
        JWT_SECRET: test-secret-key-for-ci
        NODE_ENV: test
        TEST_DATABASE_URL: sqlite+aiosqlite:///file:pytest_shared?mode=memory&cache=shared
    
    - name: Check coverage threshold
      run: |
        python -c "
        import xml.etree.ElementTree as ET
        tree = ET.parse('coverage.xml')
        root = tree.getroot()
        coverage = float(root.get('line-rate', 0)) * 100
        threshold = 90
        if coverage < threshold:
            print(f'Coverage {coverage:.2f}% is below threshold {threshold}%')
            exit(1)
        else:
            print(f'Coverage {coverage:.2f}% meets threshold {threshold}%')
        "
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: matrix.python-version == '3.10'
      with:
        files: ./coverage.xml
        flags: python
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

  node-tests:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: ["18.x", "20.x"]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Frontend type check
      run: npm run check
      continue-on-error: false
    
    - name: Frontend unit tests
      run: npm run test:frontend -- --run --coverage
      continue-on-error: false
    
    - name: Lint with ESLint
      run: npm run lint
      continue-on-error: false
    
    - name: Format check with Prettier
      run: npm run format:check
      continue-on-error: false
    
    - name: Build frontend
      run: npm run build
      env:
        NODE_ENV: production
      continue-on-error: false
    
    - name: Run all frontend tests (including command palette, notifications, export)
      run: npm run test:frontend -- --run
      continue-on-error: false
    
    - name: Upload Vite build artifacts
      uses: actions/upload-artifact@v4
      if: matrix.node-version == '18.x' && github.event_name == 'push'
      with:
        name: vite-build-${{ matrix.node-version }}
        path: dist/
        retention-days: 7

  integration-tests:
    runs-on: ubuntu-latest
    needs: [python-tests, node-tests]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Install Node dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Start services with Docker Compose
      run: |
        docker-compose up -d postgres redis
        sleep 10
    
    - name: Run integration tests
      run: |
        pytest tests/ -v -m integration || true
      env:
        DATABASE_URL: postgresql+asyncpg://crypto_user:crypto_pass@localhost:5432/cryptoorchestrator
        REDIS_URL: redis://localhost:6379/0
        JWT_SECRET: test-secret-key-for-ci
    
    - name: Cleanup
      if: always()
      run: docker-compose down

  e2e-tests:
    runs-on: ubuntu-latest
    needs: [python-tests, node-tests]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
    
    - name: Build application
      run: npm run build
    
    - name: Start application
      run: |
        npm run dev:fastapi &
        npm run dev &
        sleep 10
    
    - name: Run Playwright tests
      run: npm run test:e2e || true
      env:
        DATABASE_URL: sqlite:///./test.db
        JWT_SECRET: test-secret-key-for-ci

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install security tools
      run: |
        pip install bandit safety
        npm install -g npm-audit-resolver || true
    
    - name: Run Bandit security scan
      run: |
        bandit -r server_fastapi -f json -o bandit-report.json || true
    
    - name: Run Safety check
      run: |
        safety check --json || true
    
    - name: Run npm audit
      run: |
        npm audit --audit-level=moderate || true

  build-electron:
    runs-on: ${{ matrix.os }}
    needs: [python-tests, node-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ['18.x']
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Set up Python (for Python runtime bundling)
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Install Python dependencies (for bundling)
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Bundle Python runtime
      run: npm run bundle:python
      continue-on-error: true  # Allow to fail if Python bundling not critical
    
    - name: Build Vite frontend
      run: npm run build
      env:
        NODE_ENV: production
    
    - name: Build Electron app
      run: npm run build:electron
      env:
        # Electron builder environment variables (if needed)
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        WIN_CERT_PATH: ${{ secrets.WIN_CERT_PATH }}
        WIN_CERT_FILE: ${{ secrets.WIN_CERT_FILE }}
        WIN_CERT_PASSWORD: ${{ secrets.WIN_CERT_PASSWORD }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload Electron artifacts
      uses: actions/upload-artifact@v4
      with:
        name: electron-${{ matrix.os }}
        path: |
          dist-electron/**/*.exe
          dist-electron/**/*.dmg
          dist-electron/**/*.AppImage
          dist-electron/**/*.deb
          dist-electron/**/*.rpm
          dist-electron/**/*.zip
        retention-days: 30
        if-no-files-found: warn

  build-docker:
    runs-on: ubuntu-latest
    needs: [python-tests, node-tests]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      run: |
        docker-compose build
      env:
        DOCKER_BUILDKIT: 1
    
    - name: Test Docker Compose
      run: |
        docker-compose up -d
        sleep 15
        curl -f http://localhost:8000/healthz || exit 1
        docker-compose down
    
    - name: Upload Docker image metadata
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "Docker image built successfully"
        # Future: Push to registry if needed
