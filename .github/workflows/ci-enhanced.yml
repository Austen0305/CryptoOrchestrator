name: Enhanced CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly security scans
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      run_full_scan:
        description: 'Run full security scan'
        required: false
        type: boolean
        default: false

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Install Node dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Run code quality scan
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      run: |
        python scripts/code_quality_scan.py all --severity high || true
    
    - name: Run Python linting
      run: |
        python -m flake8 server_fastapi/ --max-line-length=120 --extend-ignore=E203,W503 --count || true
        python -m black --check server_fastapi/ || true
    
    - name: Run TypeScript linting
      run: |
        npx eslint "client/**/*.{ts,tsx}" --ext .ts,.tsx --max-warnings 50 || true

  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_cryptoorchestrator
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Set up test database
      env:
        TEST_DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/test_cryptoorchestrator
      run: |
        python -m alembic upgrade head || echo "Migrations optional for tests"
    
    - name: Run tests with coverage
      env:
        TEST_DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/test_cryptoorchestrator
        REDIS_URL: redis://localhost:6379/0
        PYTEST_CURRENT_TEST: false
      run: |
        pytest server_fastapi/tests/ -v \
          --cov=server_fastapi \
          --cov-report=xml \
          --cov-report=term-missing \
          --cov-fail-under=80 \
          --tb=short
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
      continue-on-error: true
      with:
        file: ./coverage.xml
        flags: backend
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Type check
      run: npm run check
    
    - name: Lint TypeScript
      run: npx eslint "client/**/*.{ts,tsx}" --ext .ts,.tsx --max-warnings 0 || true
    
    - name: Build frontend
      run: npm run build
    
    - name: Check build artifacts
      run: |
        if (Test-Path "dist") {
          echo "Build successful"
        } else {
          echo "Build failed - no dist directory"
          exit 1
        }

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event.inputs.run_full_scan == true
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        pip install bandit safety
        npm ci --legacy-peer-deps
    
    - name: Run Bandit security scan
      run: |
        bandit -r server_fastapi/ -ll -f json -o bandit-report.json || true
    
    - name: Run Safety check
      run: |
        safety check --json || true
    
    - name: Run npm audit
      run: |
        npm audit --audit-level=moderate || echo "Security vulnerabilities found - review required"
    
    - name: Run Snyk security scan
      uses: snyk/actions/python@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
    
    - name: Upload security reports
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
        retention-days: 30

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_cryptoorchestrator
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        npm ci --legacy-peer-deps
    
    - name: Run integration tests
      env:
        TEST_DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/test_cryptoorchestrator
        REDIS_URL: redis://localhost:6379/0
      working-directory: server_fastapi/tests
      run: |
        pytest -v -m integration || echo "Integration tests completed"

  build:
    name: Build All Packages
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, code-quality]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        npm ci --legacy-peer-deps
    
    - name: Build frontend
      run: npm run build
    
    - name: Build Electron app
      run: npm run build:electron || echo "Electron build optional"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v5
      with:
        name: build-artifacts
        path: |
          dist/
          dist-electron/
        retention-days: 7

