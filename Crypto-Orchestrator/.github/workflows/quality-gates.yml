name: Quality Gates

on:
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  quality-checks:
    name: Quality Gates
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Install Node dependencies
        run: npm ci --legacy-peer-deps

      # Code Quality Checks
      - name: Run Python linting (ruff)
        run: |
          ruff check server_fastapi/ --output-format=github || exit 1

      - name: Run Python type checking (mypy)
        run: |
          mypy server_fastapi/ --ignore-missing-imports || exit 1

      - name: Run TypeScript type checking
        run: |
          npm run check || exit 1

      - name: Run ESLint
        run: |
          npx eslint "client/**/*.{ts,tsx}" --max-warnings 0 || exit 1

      # Test Coverage
      - name: Run backend tests with coverage
        env:
          DATABASE_URL: sqlite:///./test.db
          JWT_SECRET: test-secret-key-for-ci
        run: |
          pytest server_fastapi/tests/ \
            -v \
            --cov=server_fastapi \
            --cov-report=xml \
            --cov-report=term \
            --cov-fail-under=85 \
            --maxfail=5

      - name: Run frontend tests with coverage
        run: |
          npm run test:frontend -- --coverage --coverageThreshold='{"global":{"branches":80,"functions":80,"lines":80,"statements":80}}' || exit 1

      # Code Complexity
      - name: Analyze code complexity
        run: |
          python scripts/quality/code_complexity.py server_fastapi/ --output complexity_report.md || true

      # Security Scan
      - name: Run security tests
        run: |
          python scripts/testing/security_test.py --base-url http://localhost:8000 --output security_report.md || true

      # Performance Benchmarks
      - name: Run performance tests
        run: |
          # Start server in background
          python -m uvicorn server_fastapi.main:app --host 0.0.0.0 --port 8000 &
          sleep 10
          python scripts/testing/performance_test.py --base-url http://localhost:8000 --output performance_report.md || true

      # Upload reports
      - name: Upload quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports
          path: |
            complexity_report.md
            security_report.md
            performance_report.md
          retention-days: 7
